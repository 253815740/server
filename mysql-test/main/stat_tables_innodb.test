--source include/have_innodb.inc

SET SESSION STORAGE_ENGINE='InnoDB';

set @save_optimizer_switch_for_stat_tables_test=@@optimizer_switch;
set optimizer_switch='extended_keys=on';

set @innodb_stats_persistent_save= @@innodb_stats_persistent;
set @innodb_stats_persistent_sample_pages_save=
      @@innodb_stats_persistent_sample_pages;

set global innodb_stats_persistent= 1;
set global innodb_stats_persistent_sample_pages=100;
--source stat_tables.test
set global innodb_stats_persistent= @innodb_stats_persistent_save;
set global innodb_stats_persistent_sample_pages=
             @innodb_stats_persistent_sample_pages_save;

set optimizer_switch=@save_optimizer_switch_for_stat_tables_test;

--echo #
--echo # MDEV-22851: the engine independent index statistics are incorrect for large tables. 
--echo #

CREATE TABLE t1 AS SELECT * FROM INFORMATION_SCHEMA.COLUMNS;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;
INSERT INTO t1 SELECT * FROM t1;

SET @save_use_stat_tables= @@use_stat_tables;
SET use_stat_tables= preferably;
SELECT count(*) FROM t1;
CREATE INDEX idx ON t1(TABLE_CATALOG);
ANALYZE TABLE t1 PERSISTENT FOR COLUMNS () INDEXES (idx);
SELECT * FROM mysql.index_stats where table_name='t1';
SET use_stat_tables= @save_use_stat_tables;
DROP TABLE t1;

SET SESSION STORAGE_ENGINE=DEFAULT;
